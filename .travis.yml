---

# -----------------
# YAML Templates
# -----------------
# Cross-plateform
_cross_tests: &cross_tests
  dist: trusty
  language: php
  before_script: composer install
  script:
    - php ./vendor/bin/phpcs -p -n --standard=PSR2 src
    - php ./vendor/bin/phpunit

# Documentation deployment
_doc-deploy: &doc-deploy
  stage: Deployments
  language: node_js
  node_js: 10
  env: &doc-deploy-env
    - NODE_ENV=production
    - AWS_DEFAULT_REGION=us-west-2
    - AWS_ACCESS_KEY_ID=AKIAIYAXFUAHXOWP2MJA
    # AWS_SECRET_ACCESS_KEY
    - secure: qzj0owa1ZC74eg3BBox1FWCBtDs7Xald1sfCjR52tV4/mpFu1sv5sSemzSzBfI0GYn5jAbPpm7DacmR8Y5mTxaIUXGi7mT041stjEEW3snubnsOLWxkGWpFpEZa2b8qlIxl/hzhv4wJ2rxxYCAwA9khOAc6uYunilL4yV0KCPoBD3fRYOktCNxaEbGCaFmlSphPBQYh867izCjSGNpn3kxst3+VuLE3RCikbZCuJvAZMSra4WxBcFqs6WytC5zykdkipb6O5US8koljqSdJgD1MOc0p4VrDmXum9IzBiK0omXbep3BPsorQBEvPCuHQQDk1HqJ+psKgLdwGX/nbaXHQ93smAMhUQOfF7rriYe7VeSrbHlVx/j/U7FMBoYG02efXOHH1jwO4njhQRNvbEAQnmky6my87NlCGnIUzkYeXogt+9/+MvkTDvfhYI6tVXEvoM/GSH7f12kr9gG4LSsI6PzJr8FPnp5+n+ZhqvqyEAJ3LUd/pTxAzNM+w405YeR29aeUdMkuhXHlM/lMfUR9RlnM216EM+fZH7lB2ueZV3m6AqDlIh29DRao9g6M3dkeWdtzFzZgVSrWtwhwZhmHTx6RXbz+SPDrwjQcEPuwMq8RIu9L+9/DW52vXv2u5VKHbszDWoelYza7EUbKcQ4y7NXaJV1+GfrJrpotQEScg=
  cache:
    npm: true
    directories:
      - $HOME/.cache/pip
  addons:
    apt:
      packages:
        - python
        - python-pip
  install:
    - pip install awscli --upgrade --user
  script:
    - npm run doc-prepare
    - npm run doc-build
  deploy:
    provider: script
    script:
      - npm run doc-upload
    skip_cleanup: true
  after_deploy:
    - npm run doc-cloudfront

# ------------------------
# Jobs configuration
# ------------------------
jobs:
  include:
    # ---------------------------------------
    # Unit Tests & Linters
    # ---------------------------------------
    - <<: *cross_tests
      name: "PHP 7 (with coverage)"
      stage: Unit Tests & Linters
      after_success:
        - bash <(curl -s https://codecov.io/bash)

    - name: Dead link check
      stage: Unit Tests & Linters
      language: node_js
      node_js: 10
      cache:
        directories:
          - "$HOME/.gem/specs"
          - "./doc/framework/node_modules"
      before_script:
        - npm run doc-prepare
        - npm run --prefix ./doc/framework clone-repos
      script:
        - gem install typhoeus
        - HYDRA_MAX_CONCURRENCY=20 npm run --prefix ./doc/framework dead-links

    - name: Documentation test
      stage: Unit Tests & Linters
      langage: minimal
      services:
        - docker
      script:
        - docker-compose -f .ci/doc/docker-compose.yml run doc-tests node index

    # -----------------------------------------------
    # Cross-platform tests
    # -----------------------------------------------
    - <<: *cross_tests
      name: "PHP 5.4"
      stage: Backwards compatibility
      php: 5.4

    - <<: *cross_tests
      name: "PHP 5.5"
      stage: Backwards compatibility
      php: 5.5

    - <<: *cross_tests
      name: "PHP 5.6"
      stage: Backwards compatibility
      php: 5.6

    - <<: *cross_tests
      name: "PHP 7.0"
      stage: Backwards compatibility
      php: 7.0

    # -----------------------------------------------
    # Deployments
    # -----------------------------------------------
    - <<: *doc-deploy
      name: Documentation to next-docs.kuzzle.io
      if: branch =~ /^[0-9]+-dev$/
      env:
        - *doc-deploy-env
        - S3_BUCKET=docs-next.kuzzle.io
        - CLOUDFRONT_DISTRIBUTION_ID=E2ZCCEK9GRB49U

    - <<: *doc-deploy
      name: Deploy docs.kuzzle.io
      if: branch =~ /^master|[0-9]+-stable$/
      env:
        - *doc-deploy-env
        - S3_BUCKET=docs.kuzzle.io
        - CLOUDFRONT_DISTRIBUTION_ID=E3D6RP0POLCJMM

# ------------------------
# Stages configuration
# ------------------------
stages:
  - name: Unit Tests & Linters
    if: type =~ /(cron|pull_request)/ OR (type = push AND branch =~ /^master|[0-9]+-(dev|stable)$/)
  - name: Backwards compatibility
    if: type = cron
  - name: Deployments
    if: type = push AND branch =~ /^master|[0-9]+-(dev|stable)$/
